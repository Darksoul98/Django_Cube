
## Django
- Event and DummyAPI are defined in `cube.views` 
- `serializers` Helps in validating the input and raises error if something is missing or in invalid format
- Docker has 3 services- db, web and background_tasks
- For Rule 3 tasks are stored in DB with user and event ids, to be called after specified time in decorator of `class Trigger > notify_user` in rules.py
- `background_tasks` service checks for tasks to be executed in background_tasks table
- Calls to `DummyAPI` are logged into notification.log file and printed on the console as well
- `request_log` consists of logging middleware

#### Pointers
- If you have mysql service running please stop. 
- Run migrate command to create tables in the mysql container

|       Endpoints    |Method          |
|-------------------|-----------------|
|/api/v1/event      |POST             |
|/api/v1/dummyapi      |POST             |

- Example input JSON 

Bill Pay event - 
```bash
{
    "noun": "bill",
    "userid": 178766,
    "ts": "20170315 134850",
    "latlong": "19.07,72.87",
    "verb": "pay",
    "timespent": 72,
    "properties": {
        "bank": "hdfc",
        "merchantid": 234,
        "value": 139000.5,
        "mode": "netbank"
    }
}
```

Feedback event - 
```bash
{
    "noun": "fdbk",
    "userid": 178766,
    "ts": "20170315 135250",
    "latlong": "19.07,72.87",
    "verb": "post",
    "timespent": null,
    "properties": {
        "text": "the bank page took too long to load"
    }
}
```
## Docker Setup

### Build
```bash
sudo docker-compose build
```
### Run
```bash
sudo docker-compose up -d
```
### Run migrations
```bash
sudo docker-compose run web python src/manage.py migrate
```
- Some services may not start without running migrations. 
- After running migrations run following command to start remaining services as well
```bash
sudo docker-compose up -d
```
### To tail services
```bash
sudo docker-compose logs -f web
```
```bash
sudo docker-compose logs -f background_process
```
### To tail logs generated by the API
- You can tail logs using container ID of djangocube_web 
```bash
sudo docker exec -it [CONTAINER] bash
```
```bash
tail -f src/notifications.log
```

[http://0.0.0.0:8000](http://0.0.0.0:8000)
